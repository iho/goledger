openapi: 3.0.3
info:
  title: GoLedger API
  description: Double-entry ledger system with account management, transfers, and holds
  version: 1.0.0
  contact:
    name: API Support
    email: support@goledger.io
  license:
    name: MIT

servers:
  - url: http://localhost:8080/api/v1
    description: Development server
  - url: https://api.goledger.io/v1
    description: Production server

tags:
  - name: Authentication
    description: User authentication and session management
  - name: Accounts
    description: Account management operations
  - name: Transfers
    description: Transfer operations between accounts
  - name: Holds
    description: Hold management (reserve funds)
  - name: Health
    description: System health and readiness checks

paths:
  # Authentication
  /auth/login:
    post:
      tags: [Authentication]
      summary: User login
      description: Authenticate user and return JWT token
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                  example: admin@goledger.io
                password:
                  type: string
                  format: password
                  example: Password123
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    description: JWT authentication token
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  user:
                    $ref: '#/components/schemas/UserInfo'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/me:
    get:
      tags: [Authentication]
      summary: Get current user
      description: Returns current authenticated user information
      operationId: getCurrentUser
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Current user information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserInfo'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # Accounts
  /accounts:
    post:
      tags: [Accounts]
      summary: Create account
      description: Create a new ledger account
      operationId: createAccount
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAccountRequest'
      responses:
        '201':
          description: Account created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Account'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    get:
      tags: [Accounts]
      summary: List accounts
      description: List all accounts with pagination
      operationId: listAccounts
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: List of accounts
          content:
            application/json:
              schema:
                type: object
                properties:
                  accounts:
                    type: array
                    items:
                      $ref: '#/components/schemas/Account'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /accounts/{id}:
    get:
      tags: [Accounts]
      summary: Get account
      description: Get account by ID
      operationId: getAccount
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Account details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Account'
        '404':
          $ref: '#/components/responses/NotFound'

  # Transfers
  /transfers:
    post:
      tags: [Transfers]
      summary: Create transfer
      description: Create a new transfer between accounts
      operationId: createTransfer
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTransferRequest'
      responses:
        '201':
          description: Transfer created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transfer'
        '400':
          $ref: '#/components/responses/BadRequest'
        '412':
          description: Precondition failed (insufficient funds, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /transfers/{id}:
    get:
      tags: [Transfers]
      summary: Get transfer
      description: Get transfer by ID
      operationId: getTransfer
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Transfer details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transfer'
        '404':
          $ref: '#/components/responses/NotFound'

  /transfers/{id}/reverse:
    post:
      tags: [Transfers]
      summary: Reverse transfer
      description: Create a reversal transfer
      operationId: reverseTransfer
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                metadata:
                  type: object
                  additionalProperties: true
      responses:
        '201':
          description: Reversal transfer created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transfer'
        '412':
          description: Transfer already reversed or cannot be reversed

  # Holds
  /holds:
    post:
      tags: [Holds]
      summary: Create hold
      description: Place a hold on account funds
      operationId: createHold
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateHoldRequest'
      responses:
        '201':
          description: Hold created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Hold'
        '412':
          description: Insufficient funds

  /holds/{id}/void:
    post:
      tags: [Holds]
      summary: Void hold
      description: Cancel a hold and release funds
      operationId: voidHold
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Hold voided successfully
        '412':
          description: Hold is not active or has expired

  /holds/{id}/capture:
    post:
      tags: [Holds]
      summary: Capture hold
      description: Capture a hold as a transfer
      operationId: captureHold
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [to_account_id]
              properties:
                to_account_id:
                  type: string
      responses:
        '201':
          description: Hold captured as transfer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transfer'
        '412':
          description: Hold is not active or has expired

  # Health
  /health:
    get:
      tags: [Health]
      summary: Health check
      description: Check if service is healthy
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /auth/login

  parameters:
    Limit:
      name: limit
      in: query
      description: Maximum number of results (max 1000)
      schema:
        type: integer
        minimum: 1
        maximum: 1000
        default: 50
    Offset:
      name: offset
      in: query
      description: Number of results to skip
      schema:
        type: integer
        minimum: 0
        default: 0

  schemas:
    UserInfo:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
          format: email
        role:
          type: string
          enum: [admin, operator, viewer]

    Account:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        currency:
          type: string
          pattern: '^[A-Z]{3}$'
        balance:
          type: string
          description: Current balance (decimal string)
        encumbered_balance:
          type: string
          description: Amount held (decimal string)
        allow_negative_balance:
          type: boolean
        allow_positive_balance:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateAccountRequest:
      type: object
      required: [name, currency]
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
        currency:
          type: string
          pattern: '^[A-Z]{3}$'
          example: USD
        allow_negative_balance:
          type: boolean
          default: false
        allow_positive_balance:
          type: boolean
          default: true

    Transfer:
      type: object
      properties:
        id:
          type: string
        from_account_id:
          type: string
        to_account_id:
          type: string
        amount:
          type: string
          description: Transfer amount (decimal string)
        created_at:
          type: string
          format: date-time
        event_at:
          type: string
          format: date-time
        metadata:
          type: object
          additionalProperties: true
        reversed_transfer_id:
          type: string
          nullable: true

    CreateTransferRequest:
      type: object
      required: [from_account_id, to_account_id, amount]
      properties:
        from_account_id:
          type: string
        to_account_id:
          type: string
        amount:
          type: string
          pattern: '^\d+(\.\d+)?$'
          example: "100.00"
        metadata:
          type: object
          additionalProperties: true

    Hold:
      type: object
      properties:
        id:
          type: string
        account_id:
          type: string
        amount:
          type: string
        status:
          type: string
          enum: [active, voided, captured]
        expires_at:
          type: string
          format: date-time
          nullable: true
        metadata:
          type: object
          additionalProperties: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateHoldRequest:
      type: object
      required: [account_id, amount]
      properties:
        account_id:
          type: string
        amount:
          type: string
          pattern: '^\d+(\.\d+)?$'
        expires_at:
          type: string
          format: date-time
        metadata:
          type: object
          additionalProperties: true

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        message:
          type: string

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Forbidden:
      description: Forbidden - insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
